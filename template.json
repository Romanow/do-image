{

  "variables": {
    "home": "{{env `HOME`}}"
  },
  "builders": [
    {
      "type": "digitalocean",
      "api_token": "{{user `do_token`}}",
      "image": "{{user `base_system_image`}}",
      "region": "{{user `region`}}",
      "size": "{{user `size`}}",
      "ssh_username": "root",
      "droplet_name": "base-dev-image"
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "sleep 30",
        "sudo apt-get update",
        "sudo apt-get install unzip apt-transport-https htop -y",
        "useradd --create-home --user-group --groups sudo --shell /bin/bash ansible",
        "passwd --expire ansible",
        "mkdir -p -m 0700 /home/ansible/.ssh",
        "sed -i 's/PasswordAuthentication no*/PasswordAuthentication yes/' /etc/ssh/sshd_config",
        "sed -i 's/#PubkeyAuthentication yes*/PubkeyAuthentication yes/' /etc/ssh/sshd_config",
        "systemctl restart sshd"
      ]
    },
    {
      "type": "file",
      "source": "{{ user `home` }}/.ssh/id_rsa.pub",
      "destination": "/home/ansible/.ssh/"
    },
    {
      "type": "shell",
      "inline": [
        "cd /home/ansible/.ssh",
        "cat id_rsa.pub >> authorized_keys",
        "chmod 0640 authorized_keys",
        "chown -R ansible:ansible /home/ansible/.ssh",
        "rm id_rsa.pub"
      ]
    }
  ]
}